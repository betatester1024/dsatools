import{BuildBits as x,BuildCmd as L,ConfigCmd as g,Item as h,LoaderPoint as R,Shape as t}from"/lib/dsabp-js.js";var F={H:new Map([[t.RAMP_DL,t.RAMP_DR],[t.RAMP_UL,t.RAMP_UR],[t.SLAB_L,t.SLAB_R],[t.HALF_RAMP_1_D,t.HALF_RAMP_1_DI],[t.HALF_RAMP_1_L,t.HALF_RAMP_1_RI],[t.HALF_RAMP_2_D,t.HALF_RAMP_2_DI],[t.HALF_RAMP_2_L,t.HALF_RAMP_2_RI],[t.HALF_RAMP_1_UI,t.HALF_RAMP_1_U],[t.HALF_RAMP_1_LI,t.HALF_RAMP_1_R],[t.HALF_RAMP_2_UI,t.HALF_RAMP_2_U],[t.HALF_RAMP_2_LI,t.HALF_RAMP_2_R],[t.HALF_RAMP_3_D,t.HALF_RAMP_3_DI],[t.HALF_RAMP_3_L,t.HALF_RAMP_3_RI],[t.HALF_RAMP_3_UI,t.HALF_RAMP_3_U],[t.HALF_RAMP_3_LI,t.HALF_RAMP_3_R],[t.QUARTER_DL,t.QUARTER_DR],[t.QUARTER_UL,t.QUARTER_UR],[t.QUARTER_RAMP_DL,t.QUARTER_RAMP_DR],[t.QUARTER_RAMP_UL,t.QUARTER_RAMP_UR],[t.BEVEL_DL,t.BEVEL_DR],[t.BEVEL_UL,t.BEVEL_UR]]),V:new Map([[t.RAMP_UR,t.RAMP_DR],[t.RAMP_UL,t.RAMP_DL],[t.SLAB_U,t.SLAB_D],[t.HALF_RAMP_1_R,t.HALF_RAMP_1_RI],[t.HALF_RAMP_2_R,t.HALF_RAMP_2_RI],[t.HALF_RAMP_1_UI,t.HALF_RAMP_1_D],[t.HALF_RAMP_1_DI,t.HALF_RAMP_1_U],[t.HALF_RAMP_1_LI,t.HALF_RAMP_1_L],[t.HALF_RAMP_2_UI,t.HALF_RAMP_2_D],[t.HALF_RAMP_2_DI,t.HALF_RAMP_2_U],[t.HALF_RAMP_2_LI,t.HALF_RAMP_2_L],[t.HALF_RAMP_3_R,t.HALF_RAMP_3_RI],[t.HALF_RAMP_3_L,t.HALF_RAMP_3_LI],[t.HALF_RAMP_3_UI,t.HALF_RAMP_3_D],[t.HALF_RAMP_3_DI,t.HALF_RAMP_3_U],[t.QUARTER_UR,t.QUARTER_DR],[t.QUARTER_UL,t.QUARTER_DL],[t.QUARTER_RAMP_DR,t.QUARTER_RAMP_UR],[t.QUARTER_RAMP_UL,t.QUARTER_RAMP_DL],[t.BEVEL_DR,t.BEVEL_UR],[t.BEVEL_UL,t.BEVEL_DL]])},H={H:new Map([[R.TOP_LEFT,R.TOP_RIGHT],[R.LEFT,R.RIGHT],[R.BOTTOM_LEFT,R.BOTTOM_RIGHT]]),V:new Map([[R.TOP_LEFT,R.BOTTOM_LEFT],[R.TOP,R.BOTTOM],[R.TOP_RIGHT,R.BOTTOM_RIGHT]])};for(let i of["H","V"]){for(let[s,e]of F[i])F[i].set(e,s);for(let[s,e]of H[i])H[i].set(e,s)}function w(i,s){for(let e of i.commands)e instanceof g?(e.loader?.pickupPoint!=null&&(e.loader.pickupPoint=H[s].get(e.loader.pickupPoint)??e.loader.pickupPoint),e.loader?.dropPoint!=null&&(e.loader.dropPoint=H[s].get(e.loader.dropPoint)??e.loader.dropPoint),e.pusher?.angle!=null&&(e.pusher.angle=(s=="H"?180:360)-e.pusher?.angle,e.pusher.angle<0&&(e.pusher.angle+=360)),e.angle!=null&&(e.angle=(s=="H"?180:360)-e.angle,e.angle<0&&(e.angle+=360))):e instanceof L&&(e.shape&&(e.shape=F[s].get(e.shape)??e.shape),s=="H"?(e.bits&&(e.bits=new x(e.bits.toString().split("").reduce((l,o)=>o+l)),e.x+=e.bits.size-1),e.x=i.width-e.x-1):s=="V"&&(e.y=i.height-e.y-1))}function D(i,s){let e={x:s.left,y:s.bottom},l={x:i.width-s.right-1,y:i.height-s.top-1};i.commands=i.commands.filter(a=>{if(a instanceof g)return!0;if(a instanceof L){if(a.bits&&!a.bits.isOne()){let c;for(let[f,r]of a.bits.toArray().entries())if(r==!0){if(!o(a.x+f,a.y)){c==null&&(c=a.x+f);continue}if(a.bits.clear(f),a.bits.isZero())return!1}a.x=c,a.bits.trimLeadZeros()}return o(a.x,a.y)?!1:(s.delete&&(a.x-=s.left,a.y-=s.bottom),!0)}}),s.delete&&(i.width-=s.right+s.left,i.height-=s.top+s.bottom),T(i);function o(a,c){let f=a>=e.x&&a<=l.x&&c>=e.y&&c<=l.y;return s.delete?!f:f}}function k(i,s){let e=i.width/2,l=i.height/2;s*=Math.PI/180;let o=Math.cos(s),a=Math.sin(s),c=1/0,f=1/0,r=0,m=0;p(i);for(let n of i.commands)n instanceof L&&([n.x,n.y]=M(n.x,n.y),c=Math.min(c,n.x),f=Math.min(f,n.y),r=Math.max(r,n.x),m=Math.max(m,n.y));for(let n of i.commands)n instanceof L&&(n.x=n.x-c,n.y=n.y-f);i.width=Math.ceil(r-c+1),i.height=Math.ceil(m-f+1),B(i);function M(n,_){return[I((n-e)*o-(_-l)*a+e),I((n-e)*a+(_-l)*o+l)]}}function I(i,s=10){let e=10**s;return Math.round(i*e)/e}function O(i,s){let{search:e,replacement:l}=s,o=l=="",a=0,c=new Set(b(e)),f=c.has(h.NULL),r=o?h.NULL:isNaN(l)?U(l)[0]:h.getById(parseInt(l));if(r==null)return a;let m=new Set,M=i.commands.length;for(;M--;){let n=i.commands[M];if(n instanceof L){if(f)if(n.bits){let _=0;for(let A of n.bits)A&&m.add(`${n.x+_},${n.y}`),++_}else m.add(`${n.x},${n.y}`);c.has(n.item)&&(o?i.commands.splice(M,1):(n.item=r,r.isBuildable||(n.shape=void 0)),a+=n.bits?n.bits.toArray().filter(_=>_).length:1)}}if(T(i),f){p(i);for(let n=0;n<i.width;n++)for(let _=0;_<i.height;_++)m.has(`${n},${_}`)||(i.commands.push(new L({x:n,y:_,item:r})),++a);B(i)}return a}function b(i){let s=[],e=new Set;for(let o of new Set(i))o=="block"?e.add("block"):o=="buildable"?e.add("buildable"):o=="non-buildable"||o=="nonbuildable"?e.add("nonbuildable"):o=="machine"?e.add("mac"):o=="big machine"?e.add("bigmac"):o=="1x1 machine"||o=="small machine"?e.add("smallmac"):o=="hull mounted"||o=="hull-mounted"||o=="hull"?e.add("hull"):isNaN(o)?s.push(...U(o)):s.push(h.getById(parseInt(o)));let l=o=>o.buildInfo?.[0]?.bounds.x>1||o.buildInfo?.[0]?.bounds.y>1;if(e.size)for(let o of h.getMap().values())(e.has("block")&&o.isBlock||e.has("buildable")&&o.isBuildable||e.has("nonbuildable")&&!o.isBuildable||e.has("mac")&&o.isBuildable&&!o.isBlock||e.has("bigmac")&&o.isBuildable&&!o.isBlock&&l(o)||e.has("smallmac")&&o.isBuildable&&!o.isBlock&&!l(o)||e.has("hull")&&o.isBuildable&&o.buildInfo?.[0]?.require_blocks?.[0].block.includes("HULL"))&&s.push(o);return s}function U(i){if(i=="air")return[h.NULL];let s=[];for(let e of h.getMap().values())e.name.toLowerCase().includes(i)&&s.push(e);return s}function B(i){class s{cfgCmd;commands;constructor(_,A){this.commands=[_],this.cfgCmd=A}get item(){return this.commands[0]?.item}get shape(){return this.commands[0]?.shape}}let e={},l;for(let n of i.commands)if(n instanceof g)l=n;else if(n instanceof L){e[n.y]||(e[n.y]=[]);let _=m(n);_?_.commands.push(n):e[n.y].push(new s(n,l?.clone()))}i.commands.length=0;let o=[],a,c,f=0,r=Object.values(e);for(let n=r.length-1;n>=0;n--)for(let _ of r[n]){let A=_.item==h.EXPANDO_BOX;if(c=(A?o:i.commands).length,_.cfgCmd&&!_.cfgCmd.equals(a)){let u=M(_.cfgCmd,A);u>-1?c=u:(a=_.cfgCmd,A?o.push(_.cfgCmd):i.commands.push(_.cfgCmd))}_.commands.sort((u,P)=>u.x-P.x);let d=[[]];for(let u of _.commands)u.x-d[d.length-1]?.[0]?.x>=63&&d.push([]),d[d.length-1].push(u);for(let u of d){let P=u.shift();if(u.length){P.bits=new x("1");for(let E of u)P.bits.set(Math.floor(E.x-P.x))}(A?o:i.commands).splice(P.item.isBlock?f++:c+1,0,P)}}i.commands.push(...o);function m(n){for(let _ of e[n.y])if((Math.abs(_.commands[0].x%1-n.x%1)/_.commands[0].x||0)==0&&_.item==n.item&&_.shape==n.shape&&(!(_.cfgCmd&&l)||_.cfgCmd.equals(l)))return _}function M(n,_){let A=_?o:i.commands;for(let d=A.length-1;d>=0;d--)if(A[d]instanceof g&&A[d].equals(n))return d;return-1}}function p(i){let s=i.commands.length;for(;s--;){let e=i.commands[s];if(!(e instanceof L&&e.bits&&!e.bits.isOne()))continue;i.commands.splice(s,1);let l=0,o=0;for(let a of e.bits){if(a){let c=new L({x:e.x+o,y:e.y,item:e.item,shape:e.shape});i.commands.splice(s+l,0,c),++l}++o}}}function T(i){let s=i.commands,e=s.length;for(;e--;)s[e]instanceof g&&(s[e-1]instanceof g&&s.splice(e-1,1),e==s.length-1&&s.splice(e,1))}export{D as crop,w as flip,O as replace,k as rotate};
//# sourceMappingURL=operations.js.map
